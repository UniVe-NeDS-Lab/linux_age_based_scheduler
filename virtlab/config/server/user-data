#cloud-config

hostname: server

password: password
chpasswd:
  expire: False
ssh_pwauth: True

package_update: true
packages:
  - nftables
  - conntrack
  - netcat-traditional
  - iperf

write_files:
  - path: /etc/hosts
    content: |
      127.0.0.1    localhost
      192.168.42.1 client
      192.168.42.2 server
  - path: /etc/systemd/system/iperf2.service
    content: |
      [Unit]
      Description=iPerf2 Server
      After=network.target

      [Service]
      Type=simple
      ExecStart=/usr/bin/iperf -s
      User=root
      Restart=on-failure

      [Install]
      WantedBy=multi-user.target

runcmd:
  - systemctl daemon-reload
  - systemctl enable nftables iperf2
  - systemctl start nftables iperf2

mounts:
  - [shared, /mnt/shared, "9p", "trans=virtio,version=9p2000.L", "0", "0"]
